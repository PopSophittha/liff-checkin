<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    html, body {
      margin: 0;
      padding: 10;
      height: 100%;
      font-family: sans-serif;
      background-color: #f2f2f2;
      box-sizing: border-box;
    }

    h1, #welcome {
      text-align: center;
      margin: 16px 0;
    }

    input[type="text"] {
      width: 90%;
      margin: 16px auto 24px auto;
      display: block;
      padding: 20px;
      font-size: 22px;
      border-radius: 12px;
      border: 2px solid #aaa;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .button-container {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 50vh; /* ‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ */
      display: flex;
      flex-direction: column;
      justify-content: space-evenly;
      padding: 16px;
      background: white;
      box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1);
    }

    button {
      width: 95%;
      height: 45%;
      font-size: 7vw; /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏ö‡∏ö responsive */
      font-weight: bold;
      border: none;
      border-radius: 16px;
      color: white;
      cursor: pointer;
      touch-action: manipulation;
      transition: background-color 0.2s ease, transform 0.1s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      line-height: 1.2;
      padding: 0;
    }

    button:active {
      transform: scale(0.97);
      opacity: 0.95;
    }

    .checkin {
      background-color: #4CAF50;
    }

    .checkout {
      background-color: #e53935;
    }

    .top-container {
      height: 50vh;           /* ‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ö‡∏ô‡∏Ç‡∏≠‡∏á‡∏à‡∏≠ */
      display: flex;
      flex-direction: column;
      justify-content: center;  /* ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á */
      align-items: center;      /* ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô */
      gap: 8px;                 /* ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î */
      text-align: center;
      padding: 0 10px;
    }

    .top-container h1 {
      font-size: 4vw;
      margin: 0;
      white-space: nowrap;       /* ‡πÑ‡∏°‡πà‡∏ï‡∏±‡∏î‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î */
      overflow: hidden;          /* ‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Å‡∏¥‡∏ô */
      text-overflow: ellipsis;   /* ‡πÅ‡∏™‡∏î‡∏á ... ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô */
      max-width: 100%;           /* ‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÄ‡∏ï‡πá‡∏° container */
    }

    #welcome {
      font-size: 5vw;
      margin: 0;
    }

    .top-container label {
      font-size: 5.5vw;
      margin-top: 8px;
    }

    .select-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;             /* ‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á label ‡∏Å‡∏±‡∏ö select */
      width: 95%;
      margin: 0 auto 16px auto;
    }

    .select-row label {
      font-size: 5vw;
      white-space: nowrap;   /* ‡∏Å‡∏±‡∏ô label ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà */
      flex-shrink: 0;
    }

    .select-row select {
      flex-grow: 1;          /* select ‡∏Å‡∏¥‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠ */
      font-size: 5vw;
      padding: 0.6em;
      border-radius: 16px;
      border: 2px solid #ccc;
      box-sizing: border-box;
      cursor: pointer;
    }

    #result {
      text-align: center;
      margin: 12px;
      color: green;
      font-size: 16px;
    }

    #debug {
      font-size: 12px;
      color: gray;
      white-space: pre-wrap;
      padding: 10px;
    }
    
  </style>

  <script>
    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ v= ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô URL ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
    // ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà redirect ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÅ‡∏•‡πâ‡∏ß
    if (!window.location.search.includes("v=")) {
      const baseUrl = window.location.origin + window.location.pathname;
      // ‡πÄ‡∏û‡∏¥‡πà‡∏° ?v=2 ‡∏ñ‡πâ‡∏≤ URL ‡πÑ‡∏°‡πà‡∏°‡∏µ query ‡∏≠‡∏∑‡πà‡∏ô
      // ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡∏°‡∏µ query ‡∏≠‡∏∑‡πà‡∏ô (‡πÄ‡∏ä‡πà‡∏ô ?foo=bar) ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏° &v= ‡πÅ‡∏ó‡∏ô
      let newUrl = baseUrl;
      if (window.location.search.length > 0) {
        newUrl += window.location.search + "&v=5";
      } else {
        newUrl += "?v=5";
      }
      window.location.href = newUrl;
      return;  // ‡∏´‡∏¢‡∏∏‡∏î script ‡∏´‡∏•‡∏±‡∏á redirect
    }
  </script>

  <script src="https://static.line-scdn.net/liff/edge/versions/2.27.0/sdk.js"></script>
  <script src="code.js"></script>
  <script>
    // setTimeout(() => {
      if (!window.liff) {
        alert("‚ùå LIFF SDK ‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î ‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏î‡∏ô‡∏ö‡∏•‡πá‡∏≠‡∏Ñ‡∏à‡∏≤‡∏Å CSP");
      } else {
        // log("‚úÖ LIFF SDK ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß");
        console.log("‚úÖ LIFF SDK ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß", window.liff);
      }
    // }, 3000);

    let displayName = "";
    let currentStatus = ""; // checkin / checkout

    async function main() {
      try {
        try {
          log("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î LIFF...");
          await liff.init({ liffId: "2007788493-vwxmBkLE" });
          log("‚úÖ LIFF init success");
          console.log("‚úÖ LIFF init success");
        } catch (e) {
          log("‚ùå LIFF init failed:" + JSON.stringify(e));
          console.error("‚ùå LIFF init failed:", e);
          alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ init LIFF: " + JSON.stringify(e));
        }

        log("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö");
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        log("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ");
        const profile = await liff.getProfile();
        displayName = profile.displayName;

        document.getElementById("welcome").innerText = "üë§ Welcome " + displayName;
        getLocation();
      } catch (err) {
        document.getElementById("welcome").innerText = "‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message;
        alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err);
        console.error("LIFF error:", err);
      }
    }

    function getLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(successCallback, errorCallback);
      } else {
        alert("‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Geolocation");
      }
    }

    function successCallback(position) {
      const lat = position.coords.latitude;
      const lng = position.coords.longitude;

      // document.getElementById('latText').innerText = lat;
      // document.getElementById('lngText').innerText = lng;

      document.getElementById('latHidden').value = lat;
      document.getElementById('lngHidden').value = lng;
    }

    function errorCallback(error) {
      switch(error.code) {
        case error.PERMISSION_DENIED:
          alert("‡∏Ñ‡∏∏‡∏ì‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á");
          break;
        case error.POSITION_UNAVAILABLE:
          alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏´‡∏≤‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ");
          break;
        case error.TIMEOUT:
          alert("‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á");
          break;
        default:
          alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏");
      }
    }

    function submitForm(statusType) {
      // displayName = document.getElementById("employeeName").value;

      // if (!displayName) {
      //   alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡πà‡∏≠‡∏ô");
      //   return;
      // }
      
      currentStatus = statusType;

      const lat = document.getElementById('latHidden').value;
      const lng = document.getElementById('lngHidden').value;
      // const note = document.getElementById('note').value;

      if (!lat || !lng) {
        alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏¥‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á');
        return;
      }

      //for submit to web api in GAS
      fetch('https://script.google.com/macros/s/AKfycbx60MJv0fLPsoHR13uDkFdbHi2pdUsNM7C_NypCrA1zQf-yiB6k0LaatSfGFAYPTbk/exec', {
        method: 'POST',
        body: JSON.stringify({
          name: displayName,
          status: statusType,
          lat: lat,
          lng: lng
        }),
        headers: {
          'Content-Type': 'application/json'
        }
      })
      .then(response => response.json())
      .then(data => {
        alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        // ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° LINE ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏û‡∏¥‡∏Å‡∏±‡∏î
      })
      .catch(error => {
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
      });
      
      // for use inside GAS
      // google.script.run.withSuccessHandler(function(status) {
      //   alert("üìå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å " + status + " ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!");
      //   liff.closeWindow(); // ‡∏õ‡∏¥‡∏î LIFF ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏î OK ‡πÉ‡∏ô alert //‡πÉ‡∏Ç‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠ init liff ‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå

      //   // ‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ä‡∏ó‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
      //   if (liff.isInClient()) {
      //     summaryMessage();
      //   } else {
      //     console.warn("‚ùå ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡πÉ‡∏ô‡πÅ‡∏ä‡∏ó LINE OA");
      //   }

      //   getLocation(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡∏°‡πà ‡∏´‡∏≤‡∏Å‡πÉ‡∏ä‡πâ‡∏ï‡πà‡∏≠
      // }).saveLocation(displayName, currentStatus, lat, lng);
    }

    function log(msg) {
      const debug = document.getElementById("debug");
      debug.innerText += msg + "\n";
    }

    function timeout(ms, promise) {
      return new Promise((resolve, reject) => {
        const timer = setTimeout(() => reject(new Error("‚è∞ LIFF init timeout")), ms);
        promise
          .then((value) => {
            clearTimeout(timer);
            resolve(value);
          })
          .catch((err) => {
            clearTimeout(timer);
            reject(err);
          });
      });
    }

    function summaryMessage() {
      const lat = document.getElementById('latHidden').value;
      const lng = document.getElementById('lngHidden').value;
      const status = currentStatus;

      const message = {
        type: 'text',
        text: `üìå {displayName} ${status} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à\nüìç ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á: ${lat}, ${lng}`
      };

      liff.sendMessages([message])
        .then(() => {
          console.log('Message sent');
          liff.closeWindow();
        })
        .catch((err) => {
          console.error('Error sending message:', err);
          alert('‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message);
        });
    }


    // ‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠ DOM ‡∏û‡∏£‡πâ‡∏≠‡∏°
    document.addEventListener("DOMContentLoaded", main);
  </script>
</head>
<body>
  <div class="top-container">
    <h1>Manta Pharmacy checkin/checkout v5.0</h1>
    <p id="welcome">üë§ Welcome loading...</p>

<!--     <div class="select-row">
      <label for="employeeName">‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô:</label>
      <select id="employeeName">
        <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
        <option value="‡πÅ‡∏à‡∏á">‡πÅ‡∏à‡∏á</option>
        <option value="‡∏£‡∏±‡∏ï‡∏ô‡πå">‡∏£‡∏±‡∏ï‡∏ô‡πå</option>
        <option value="‡∏ô‡∏±‡∏ô">‡∏ô‡∏±‡∏ô</option>
        <option value="‡∏ö‡∏µ‡∏ä">‡∏ö‡∏µ‡∏ä</option>
        <option value="‡∏ô‡πä‡∏≠‡∏ï">‡∏ô‡πä‡∏≠‡∏ï</option>
        <option value="‡∏û‡∏ß‡∏á">‡∏û‡∏ß‡∏á</option>
        <option value="‡πÄ‡∏Å‡∏®">‡πÄ‡∏Å‡∏®</option>
        <option value="‡πÇ‡∏ö‡∏ß‡πå">‡πÇ‡∏ö‡∏ß‡πå</option>
        <option value="‡∏õ‡∏∏‡∏¢">‡∏õ‡∏∏‡∏¢</option>
        <option value="‡πÄ‡∏ô‡πá‡∏ï">‡πÄ‡∏ô‡πá‡∏ï</option>
        <option value="‡∏Å‡∏£‡∏∏‡πä‡∏õ">‡∏Å‡∏£‡∏∏‡πä‡∏õ</option>
        <option value="‡∏õ‡∏≤‡∏¢">‡∏õ‡∏≤‡∏¢</option>
        <option value="‡∏à‡∏∏‡πä‡∏ö">‡∏à‡∏∏‡πä‡∏ö</option>
        <option value="‡∏ß‡πà‡∏≤‡∏ô">‡∏ß‡πà‡∏≤‡∏ô</option>
        <option value="‡∏î‡∏±‡∏£">‡∏î‡∏±‡∏£</option>
        <option value="‡∏Ç‡∏ô‡∏°‡∏ú‡∏¥‡∏á">‡∏Ç‡∏ô‡∏°‡∏ú‡∏¥‡∏á</option>
        <option value="‡∏õ‡∏≠‡∏¢">‡∏õ‡∏≠‡∏¢</option>
        <option value="‡∏à‡∏±‡∏Å‡∏£">‡∏à‡∏±‡∏Å‡∏£</option>
        <option value="‡∏ô‡∏π‡∏ô‡∏π">‡∏ô‡∏π‡∏ô‡∏π</option>
      </select>
    </div> -->
  </div>

  <div>
    <!-- <label><b>‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î:</b> <span id="latText">-</span></label><br> -->
    <!-- <label><b>‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î:</b> <span id="lngText">-</span></label><br><br> -->

    <!-- hidden values ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏Å‡∏±‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏° -->
    <input type="hidden" id="latHidden" name="lat">
    <input type="hidden" id="lngHidden" name="lng">
  </div>

  <!-- <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</label> -->
  <!-- <input type="text" id="note" name="note"><br><br> -->

  <div class="button-container">
    <button class="checkin" onclick="submitForm('Check In')">üìç Check In</button>
    <button class="checkout" onclick="submitForm('Check Out')">üïí Check Out</button>
  </div>

  <pre id="debug" style="color:gray; font-size:12px;"></pre>
  <div id="result" style="margin-top:20px; color:green;"></div>
</body>
</html>
